<!DOCTYPE html>
<html>
<head>
    <title>Hello, Raylib!</title>
    <style>

        :root {
            --color-dark: #181818;
            --color-lite: #e7e7e7;
        }

        body {
            /* Lite Mode */
            background: var(--color-lite);
            color: var(--color-dark);

            /* Dark Mode */
            @media (prefers-color-scheme: dark) {
                background: var(--color-dark);
                color: var(--color-lite);
            }
        }

        #game {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid var(--color-dark);

            @media (prefers-color-scheme: dark) {
               border: 1px solid var(--color-lite);
            }

        }

        .raylib-select {
            display: block;
            max-width: 8rem;
        }

        .not-hosted-msg {
            text-align: center;
            position: absolute;

            top: 50%;
            left: 50%;

            transform: translate(-50%, -50%);
        }

        .not-hosted-msg .important {
            font-weight: bold;
        }
        @font-face {
            font-family: grixel;
            src: url(fonts/acme_7_wide_xtnd.woff);
        }

        .warning-msg {
            color: red;
            font-weight: bold;
        }
    </style>
    <!-- Hack for GitHub Pages found on https://github.com/tsoding/zozlib.js/pull/46 -->
    <script src="enable-threads.js"></script>
</head>
<body>
    <div id="buffer-warning" class="warning-msg" hidden>
        SharedArrayBuffer is not available.
    </div>
    <label for="raylib-example-select">Choose an Example:</label>
    <select id="raylib-example-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <label for="raylib-env-select">Execution context:</label>
    <select id="raylib-env-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <label for="raylib-impl-select">Implementation:</label>
    <select id="raylib-impl-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <label for="raylib-mth-select">Rendering method:</label>
    <select id="raylib-mth-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <label for="raylib-rnd-select">Renderer:</label>
    <select id="raylib-rnd-select" class="raylib-select" onchange="run()">
        <!-- This is populated by js -->
    </select>
    <canvas id="game"></canvas>
    <script type="module">
        import { EVENT_TYPE, RaylibJs, makePlatform, glfwKeyMapping } from "./raylib.js"
        import { IMPL, RENDERING_METHOD } from "./raylib_factory.js"
        import { RaylibJsWorker, RENDERER } from "./raylib_worker.js"

        function addEventListeners (raylibJs, canvas) {
            const keyDown = (e) => raylibJs.send({
                type: EVENT_TYPE.KEY_DOWN,
                keyCode: glfwKeyMapping[e.code],
            })
            const keyUp = (e) => raylibJs.send({
                type: EVENT_TYPE.KEY_UP,
                keyCode: glfwKeyMapping[e.code]
            })
            const wheelMove = (e) => raylibJs.send({
                type: EVENT_TYPE.WHEEL_MOVE,
                direction: Math.sign(-e.deltaY),
            })
            const mouseMove = (e) => {
                const rect = canvas.getBoundingClientRect();
                raylibJs.send({
                    type: EVENT_TYPE.MOUSE_MOVE,
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top,
                })
            };

            window.addEventListener("keydown", keyDown);
            window.addEventListener("keyup", keyUp);
            window.addEventListener("wheel", wheelMove);
            window.addEventListener("mousemove", mouseMove);
            return () => {
                window.removeEventListener("mousemove", mouseMove);
                window.removeEventListener("wheel", wheelMove);
                window.removeEventListener("keyup", keyUp);
                window.removeEventListener("keydown", keyDown);
            }
        }

        function makeRunner ({
            exampleSelector,
            envSelector,
            implSelector,
            mthSelector,
            rendererSelector,
            canvas,
            worker,
            rendererWorker,
        }) {
            let raylibJs = undefined
            let removeEventListeners = undefined
            const factories = {
                "main": ({ canvas, platform }) => new RaylibJs(
                    canvas.getContext("2d"),
                    platform
                ),
                "worker": (params) => new RaylibJsWorker(params),
            }
            const pathFactory = (impl, example) => {
                switch (impl) {
                case IMPL.GAME_FRAME:
                    return `wasm/${example}.wasm`
                case IMPL.BLOCKING:
                case IMPL.LOCKING:
                case IMPL.UNLOCKED:
                    return `wasm/${example}.native.wasm`
                }
            }
            const envPathFactories = {
                "main": (_, example) => pathFactory(IMPL.GAME_FRAME, example),
                "worker": pathFactory
            }
            let oldCanvas = canvas
            const stop = async () => {
                if (raylibJs === undefined) {
                    return
                }
                await raylibJs.stop()
                removeEventListeners()
                raylibJs.destroy()
            }
            return async () => {
                await stop()
                const newCanvas = document.createElement("canvas")
                newCanvas.id = oldCanvas.id
                oldCanvas.replaceWith(newCanvas)
                oldCanvas = newCanvas
                const impl = implSelector.value
                const env = envSelector.value
                raylibJs = factories[env]({
                    impl,
                    canvas: newCanvas,
                    platform: makePlatform({
                        canvas: newCanvas
                    }),
                    rendering: mthSelector.value,
                    renderer: rendererSelector.value,
                    worker,
                    rendererWorker,
                })
                removeEventListeners = addEventListeners(raylibJs, newCanvas)
                return raylibJs.start({
                    wasmPath: envPathFactories[env](impl, exampleSelector.value),
                })
            }
        }

        function makeQueryUpdater (...params) {
            const queryParams = new URLSearchParams(window.location.search);
            for (const { name, isValid, selector, defaultValue } of params) {
                const value = queryParams.get(name);
                selector.value = isValid(value) ? value : defaultValue
            }
            return () => {
                for (const { name, selector, when, defaultValue } of params) {
                    if (selector.disabled = (when && !when(Object.fromEntries(queryParams)))) {
                        selector.value = defaultValue
                    }
                    queryParams.set(name, selector.value);
                }
                history.pushState(null, null, "?"+queryParams.toString());
            }
        }

        function makeWarningShower(element) {
            return () => {
                element.hidden = Boolean(window.SharedArrayBuffer)
            }
        }

        const wasmPaths = {
            "tsoding": ["tsoding_ball", "tsoding_snake",],
            "core": ["core_basic_window", "core_basic_screen_manager", "core_input_keys", "core_input_mouse_wheel",],
            "shapes": ["shapes_colors_palette"],
            "text": ["text_writing_anim"],
            "textures": ["textures_logo_raylib"],
        }
        const defaultWasm = Object.values(wasmPaths)[0][0];

        const raylibExampleSelect = document.getElementById("raylib-example-select");
        for (const exampleCategory in wasmPaths) {
            raylibExampleSelect.innerHTML += `<optgroup label="${exampleCategory}">`
            for (const example of wasmPaths[exampleCategory]) {
                raylibExampleSelect.innerHTML += `<option>${example}</option>`
            }
            raylibExampleSelect.innerHTML += "</optgroup>"
        }

        const envs = {
            "main": "main thread",
            "worker": "worker thread",
        }
        const defaultEnv = Object.keys(envs)[0];
        const raylibEnvSelect = document.getElementById("raylib-env-select");
        for (const env in envs) {
            raylibEnvSelect.innerHTML += `<option value="${env}">${envs[env]}</option>`
        }

        const impls = {
            [IMPL.GAME_FRAME]: "game frame",
            [IMPL.BLOCKING]: "blocking",
            [IMPL.LOCKING]: "locking",
            [IMPL.UNLOCKED]: "unlocked",
        }
        const defaultImpl = IMPL.GAME_FRAME
        const raylibImplSelect = document.getElementById("raylib-impl-select");
        for (const impl in impls) {
            raylibImplSelect.innerHTML += `<option value="${impl}">${impls[impl]}</option>`
        }

        const methods = {
            [RENDERING_METHOD.DD]: "putImageData",
            [RENDERING_METHOD.BITMAP]: "transferFromImageBitmap",
        }
        const defaultMth = RENDERING_METHOD.DD
        const raylibMthSelect = document.getElementById("raylib-mth-select");
        for (const mth in methods) {
            raylibMthSelect.innerHTML += `<option value="${mth}">${methods[mth]}</option>`
        }

        const renderers = {
            [RENDERER.MAIN_THREAD]: "main thread",
            [RENDERER.WORKER_THREAD]: "worker thread",
        }
        const defaultRenderer = RENDERER.MAIN_THREAD
        const raylibRendererSelect = document.getElementById("raylib-rnd-select");
        for (const renderer in renderers) {
            raylibRendererSelect.innerHTML += `<option value="${renderer}">${renderers[renderer]}</option>`
        }

        const run = makeRunner({
            exampleSelector: raylibExampleSelect,
            envSelector: raylibEnvSelect,
            implSelector: raylibImplSelect,
            mthSelector: raylibMthSelect,
            rendererSelector: raylibRendererSelect,
            canvas: document.getElementById("game"),
            worker: new Worker("raylib.worker.js", {
                type: "module",
            }),
            rendererWorker: new Worker("renderer.worker.js", {
                type: "module",
            }),
        })
        const updateQuery = makeQueryUpdater(
            {
                name: "example",
                selector: raylibExampleSelect,
                defaultValue: defaultWasm,
                isValid: (value) => Object.values(wasmPaths).flat().includes(value),
            },
            {
                name: "env",
                selector: raylibEnvSelect,
                defaultValue: defaultEnv,
                isValid: (value) => value in envs,
            },
            {
                name: "impl",
                selector: raylibImplSelect,
                defaultValue: defaultImpl,
                isValid: (value) => value in impls,
                when: ({ env }) => env === "worker",
            },
            {
                name: "mth",
                selector: raylibMthSelect,
                defaultValue: defaultMth,
                isValid: (value) => value in methods,
                when: ({ impl }) => impl !== IMPL.GAME_FRAME
            },
            {
                name: "rnd",
                selector: raylibRendererSelect,
                defaultValue: defaultRenderer,
                isValid: (value) => value in renderers,
                when: ({ impl }) => impl !== IMPL.GAME_FRAME
            }
        )
        const showWarning = makeWarningShower(
            document.getElementById("buffer-warning")
        )
        window.run = () => {
            showWarning()
            updateQuery()
            run()
        }

        const { protocol } = window.location;
        const isHosted = protocol !== "file:";
        
        window.addEventListener("load", isHosted ? window.run : () => {
            document.body.innerHTML = `
                <div class="not-hosted-msg">
                    <div class="important">
                        <p>Unfortunately, due to CORs restrictions, the wasm assembly cannot be fetched.</p>
                        <p>Please navigate to this location using a web server.</p>
                        <p>If you have Python 3 on your system you can just do:</p>
                    </div>
                    <code>$ python3 server.py</code>
                </div>
                `;
        })
    </script>
</body>
</html>